<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Jenks Family Medicine</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/logo.png') }}" type="image/png">
    <style>
        body {
            background-color: var(--bg-surface);
        }

        .admin-topbar {
            background: #fff;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            padding: 0.75rem 0;
        }

        .admin-topbar .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-topbar .logo-img {
            height: 40px;
        }

        .admin-topbar-right {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            font-size: 0.9rem;
        }

        .admin-topbar-right .admin-email {
            color: var(--text-light);
        }

        .admin-topbar-right a {
            color: var(--primary-color);
            font-weight: 600;
        }

        .admin-main {
            max-width: 800px;
            margin: 2.5rem auto;
            padding: 0 1.5rem;
        }

        .admin-main h1 {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
        }

        .admin-panel {
            background: #fff;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: 2rem 2.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .admin-panel h2 {
            font-size: 1.35rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #f1f1f1;
        }

        .admin-form-group {
            margin-bottom: 1.25rem;
        }

        .admin-form-group label {
            display: block;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.35rem;
            color: var(--text-color);
        }

        .admin-form-group input[type="text"],
        .admin-form-group input[type="password"],
        .admin-form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-family: var(--body-font);
            transition: border-color 0.2s;
        }

        .admin-form-group input:focus,
        .admin-form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(55, 164, 219, 0.15);
        }

        .admin-form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .toggle-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 999px;
            transition: 0.3s;
        }

        .toggle-slider::before {
            content: "";
            position: absolute;
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: #fff;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: var(--primary-color);
        }

        .toggle-switch input:checked+.toggle-slider::before {
            transform: translateX(22px);
        }

        .toggle-label {
            font-size: 0.95rem;
            color: var(--text-color);
            font-weight: 500;
        }

        .banner-preview {
            background-color: var(--primary-color);
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        .banner-preview.visible {
            display: block;
        }

        .banner-preview-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .admin-panel .button {
            margin-top: 0.5rem;
        }

        .flash-messages {
            margin-bottom: 1.5rem;
        }

        .flash-message {
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .flash-message.success {
            background-color: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .flash-message.error {
            background-color: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .flash-message.info {
            background-color: #eff6ff;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .session-warning {
            display: none;
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: #fef3cd;
            color: #856404;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            font-size: 0.9rem;
            z-index: 9999;
            border: 1px solid #ffc107;
        }
    </style>
</head>

<body>
    <!-- Admin Top Bar -->
    <header class="admin-topbar">
        <div class="container">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Jenks Family Medicine" class="logo-img">
            <div class="admin-topbar-right">
                <span class="admin-email">{{ current_user.email }}</span>
                <a href="{{ url_for('admin_logout') }}">Log Out</a>
            </div>
        </div>
    </header>

    <div class="admin-main">
        <h1>Admin Dashboard</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="flash-message {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- Banner Management -->
        <div class="admin-panel">
            <h2>üì¢ Homepage Banner</h2>
            <form method="POST" action="{{ url_for('admin_dashboard') }}">
                <input type="hidden" name="action" value="update_banner">

                <div class="toggle-row">
                    <label class="toggle-switch">
                        <input type="checkbox" name="is_active" id="banner-toggle" {{ 'checked' if banner.is_active
                            else '' }} onchange="updatePreview()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="toggle-label">Show banner on homepage</span>
                </div>

                <div class="admin-form-group">
                    <label for="banner-message">Banner Message</label>
                    <textarea id="banner-message" name="message" placeholder="e.g. We are now accepting new patients!"
                        oninput="updatePreview()">{{ banner.message }}</textarea>
                </div>

                <p class="banner-preview-label">Preview</p>
                <div class="banner-preview" id="banner-preview">
                    <span id="preview-text">{{ banner.message }}</span>
                </div>

                <button type="submit" class="button">Save Banner</button>
            </form>
        </div>

        <!-- Change Password -->
        <div class="admin-panel">
            <h2>üîí Change Password</h2>
            <form method="POST" action="{{ url_for('admin_dashboard') }}">
                <input type="hidden" name="action" value="change_password">

                <div class="admin-form-group">
                    <label for="current_password">Current Password</label>
                    <input type="password" id="current_password" name="current_password" required
                        autocomplete="current-password">
                </div>

                <div class="admin-form-group">
                    <label for="new_password">New Password</label>
                    <input type="password" id="new_password" name="new_password" required autocomplete="new-password"
                        minlength="6">
                </div>

                <div class="admin-form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" required
                        autocomplete="new-password">
                </div>

                <button type="submit" class="button">Update Password</button>
            </form>
        </div>
    </div>

    <!-- Session timeout warning -->
    <div class="session-warning" id="session-warning">
        ‚ö†Ô∏è Your session will expire soon due to inactivity.
    </div>

    <script>
        // --- Banner preview ---
        function updatePreview() {
            const toggle = document.getElementById('banner-toggle');
            const message = document.getElementById('banner-message').value.trim();
            const preview = document.getElementById('banner-preview');
            const previewText = document.getElementById('preview-text');

            previewText.textContent = message || '(empty message)';
            if (toggle.checked && message) {
                preview.classList.add('visible');
            } else {
                preview.classList.remove('visible');
            }
        }

        // Run on page load
        updatePreview();

        // --- Session inactivity warning ---
        const SESSION_TIMEOUT = 5 * 60 * 1000;  // 5 minutes
        const WARNING_BEFORE = 60 * 1000;        // warn 1 minute before

        let warningTimer, logoutTimer;

        function resetTimers() {
            clearTimeout(warningTimer);
            clearTimeout(logoutTimer);
            document.getElementById('session-warning').style.display = 'none';

            warningTimer = setTimeout(() => {
                document.getElementById('session-warning').style.display = 'block';
            }, SESSION_TIMEOUT - WARNING_BEFORE);

            logoutTimer = setTimeout(() => {
                window.location.href = "{{ url_for('admin_logout') }}";
            }, SESSION_TIMEOUT);
        }

        // Reset on any user activity
        ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetTimers, { passive: true });
        });

        resetTimers();
    </script>
</body>

</html>